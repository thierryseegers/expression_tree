<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>expression_tree: expression_tree</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">expression_tree
   &#160;<span id="projectnumber">3.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">expression_tree </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#introduction">Introduction</a></li>
<li class="level1"><a href="#considerations">Technical considerations</a></li>
<li class="level1"><a href="#optimizations">Optimizations</a><ul><li class="level2"><a href="#caching">Branch caching</a><ul><li class="level3"><a href="#evaluation">Caching-on-evaluation optimization</a></li>
<li class="level3"><a href="#assignment">Caching-on-assignment optimization</a></li>
<li class="level3"><a href="#degenerate">Degenerate case of caching-on-assignment optimization</a></li>
</ul>
</li>
<li class="level2"><a href="#multithreaded">Parallel evaluation</a></li>
</ul>
</li>
<li class="level1"><a href="#improvements">Future improvements</a></li>
<li class="level1"><a href="#sample">Sample code</a></li>
<li class="level1"><a href="#license">License</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="introduction"></a>
Introduction</h1>
<p>An expression tree is a tree that stores data in its leaf nodes and operations in its branch nodes. The tree's value can then be obtained by performing a postorder traversal, applying each branch's operation to its children.</p>
<p>For example, this tree evaluates to (2 * 1 + (2 - <em>x</em>)):</p>
<div class="fragment"><div class="line">(2 * l + r)</div>
<div class="line"> /       \</div>
<div class="line">1      (l - r)</div>
<div class="line">        /   \</div>
<div class="line">      2      x</div>
</div><!-- fragment --><p>To build an expression tree with <a class="el" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree</a>, you assign <a href="http://www.google.com/search?q=c%2B%2B+function+object">function objects</a> to branch nodes and either constant values or pointers to variables to leaf nodes. When your tree is built, call its <a class="el" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad">evaluate </a> member function to get its value.</p>
<h1><a class="anchor" id="considerations"></a>
Technical considerations</h1>
<p>This implementation:</p>
<ul>
<li>is contained in a single header file.</li>
<li>uses templates heavily.</li>
<li>specializes the branches and the leaves to reduce space overhead.</li>
<li>is dependent on C++11's function&lt;&gt; class</li>
<li>can take advantage of multithreading hardware if the <code>&lt;future&gt;</code> header is available.</li>
<li>requires RTTI.</li>
<li>has little in the way of safety checks.</li>
<li>has been tested with GCC 4.2.1, GCC 4.5.0, GCC 4.6.3, VS 2008, VS 2010 and VS 11 Beta.<ul>
<li>Note that, as of this writing, GCC up to version 4.7 does not implement std::async <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=51617">as one would expect</a>. Thus, <a class="el" href="index.html#multithreaded">parallel evaluation</a> will only truly be parallel when the implementation is corrected.</li>
</ul>
</li>
</ul>
<p>In order to be evaluated, the tree must be correctly formed. That is, all its branch nodes' children nodes must have been given a value.</p>
<h1><a class="anchor" id="optimizations"></a>
Optimizations</h1>
<p>Two policies are vailable as template parameters to <a class="el" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree</a>. The first enables caching the value of certain branches to avoid unnecessary evaluation. The second enables multi-threaded evaluation.</p>
<h2><a class="anchor" id="caching"></a>
Branch caching</h2>
<p>Caching optimizations rely on the constness of branches. Once a constant branch has been evaluated, it is not required to evaluate it again. A branch is considered constant when all its children are constant, be they branches or leaves. A leaf is considered constant when its value is assigned a constant value rather than a variable value (i.e. a pointer).</p>
<p>The first optimization caches a branch's value when a it is first evaluated. The second, more aggressive optimziation, caches when a branch's children are assigned to. The default policy is <a class="el" href="structexpression__tree_1_1no__caching.html">no_caching </a> which performs no caching.</p>
<h3><a class="anchor" id="evaluation"></a>
Caching-on-evaluation optimization</h3>
<p>By instantiating a <a class="el" href="classexpression__tree_1_1tree.html">tree </a> with its second template parameter set to <a class="el" href="structexpression__tree_1_1cache__on__evaluation.html">cache_on_evaluation </a>, a tree's evaluation will be optimzed by caching-on-evaluation. Caching on evaluation simply consists on remembering a branch's value at the time it is evaluated, if that branch is considered constant.</p>
<p>Consider the following tree, where B<sub>n</sub> is a branch, C<sub>n</sub> is a constant value and x<sub>n</sub> is a variable value:</p>
<div class="fragment"><div class="line">  B1</div>
<div class="line"> /  \</div>
<div class="line">x1  B2</div>
<div class="line">   /  \</div>
<div class="line">  C2  C3</div>
</div><!-- fragment --><p>When that tree is evaluated, B<sub>2</sub>'s value will be cached because its children are constant. If C<sub>2</sub> and C<sub>3</sub> don't change (i.e. if they are not assigned a different constant value), the second time the tree is evaluated, the evaluation of B<sub>2</sub> will return its cached value. It will not perform its operation on its children again.</p>
<p>Because one of B<sub>1</sub> children is not constant, evaluating B<sub>1</sub> will always perform its operation on its two children.</p>
<h3><a class="anchor" id="assignment"></a>
Caching-on-assignment optimization</h3>
<p>By instantiating a <a class="el" href="classexpression__tree_1_1tree.html">tree </a> with its second template parameter set to <a class="el" href="structexpression__tree_1_1cache__on__assignment.html">cache_on_assignment </a>, a tree's evaluation will be optimzed by caching-on-assignment. Caching-on-assignment means that when a branch's children nodes are assigned to, and if those children are constant, the branch's value is evaluated and cached.</p>
<p>Consider the following tree, where B<sub>n</sub> is a branch and C<sub>n</sub> is a constant value:</p>
<div class="fragment"><div class="line">  B1</div>
<div class="line"> /  \</div>
<div class="line">C1  B2</div>
<div class="line">   /  \</div>
<div class="line">  C2  C3</div>
</div><!-- fragment --><p>Let's assume that that tree is constructed in the following order: B<sub>1</sub>, C<sub>1</sub>, B<sub>2</sub>, C<sub>2</sub>, C<sub>3</sub>.</p>
<p>Upon assignment of C<sub>3</sub>, B<sub>2</sub> will be found to be of constant value and be pre-evaluated. This pre-evaluation will continue recursively up the tree for as long as a branch's both children are constant. In this case, B<sub>1</sub> will also be pre-evaluated.</p>
<p>If C<sub>1</sub> had instead been a variable (e.g. <em>x</em>), only B<sub>2</sub> will have been pre-evaluated. Evaluating B1 would then always perform its operation on its two children.</p>
<h3><a class="anchor" id="degenerate"></a>
Degenerate case of caching-on-assignment optimization</h3>
<p>Given the following tree:</p>
<div class="fragment"><div class="line">  B1</div>
<div class="line"> /  \</div>
<div class="line">C1  B2</div>
<div class="line">   /  \</div>
<div class="line">  C2  B3</div>
<div class="line">     /  \</div>
<div class="line">    C3   B4</div>
<div class="line">        / .</div>
<div class="line">       C4  .</div>
<div class="line">            .</div>
<div class="line">            Bn</div>
<div class="line">           /  \</div>
<div class="line">          Cn  Cn+1</div>
</div><!-- fragment --><p>Let's assume that that tree is constructed in the following order: B<sub>1</sub>, C<sub>1</sub>, B<sub>2</sub>, C<sub>2</sub>, ..., B<sub>n</sub>, C<sub>n</sub>, C<sub>n+1</sub>.</p>
<p>Before C<sub>n+1</sub> is assigned to, none of the tree has been pre-evaluated, given that none of its nodes' constness can be confirmed. When C<sub>n+1</sub> is assigned to, B<sub>n</sub> will be found constant and be evaluated. B<sub>n-1</sub> will also be found constant and be evaluated. This will continue until entire tree is evaluated. Thus, a single assignment can trigger the equivalent of <a class="el" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad">evaluate() </a>.</p>
<h2><a class="anchor" id="multithreaded"></a>
Parallel evaluation</h2>
<p>This optimization depends on the availability of C++11's <code>&lt;future&gt;</code> header. It is enabled automatically if your toolchain supports it. To benefit from parallel evaluation, a tree must be instantiated a <a class="el" href="classexpression__tree_1_1tree.html">tree </a> with the <a class="el" href="structexpression__tree_1_1parallel.html">parallel </a> policy class.</p>
<p>When enabled, a branch will evaluate one of its children on the current thread and its other child on a separate, hardware permitting. The decision to actually spawn a seperate thread is left to <code>std::async's</code> implementation. For large enough tree's the hardware limit will be reached and branches will start evaluating their children sequentially regardless of their threading policy.</p>
<p>The default policy is <a class="el" href="structexpression__tree_1_1sequential.html">sequential </a> which evalutes the tree sequentially.</p>
<h1><a class="anchor" id="improvements"></a>
Future improvements</h1>
<ul>
<li>I'll think of something. I can't help myself.</li>
</ul>
<h1><a class="anchor" id="sample"></a>
Sample code</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="expression__tree_8h.html" title="The only file you need.">expression_tree.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;Windows.h&gt;</span></div>
<div class="line"><span class="preprocessor">#elif defined(__linux__)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/resource.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#elif defined(__APPLE__)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;mach/mach_init.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;mach/task.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;mach/task_info.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">using namespace </span>std;</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function keeps the thread it is run on busy for one second&#39;s worth of CPU time.</span></div>
<div class="line"><span class="comment">// Two implementations are provided, one for Windows, the other for Linux.</span></div>
<div class="line">nullptr_t busy_1_sec(<span class="keyword">const</span> nullptr_t&amp;, <span class="keyword">const</span> nullptr_t&amp;)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    FILETIME a, b, kernel_ft, user_ft;</div>
<div class="line">    GetThreadTimes(GetCurrentThread(), &amp;a, &amp;b, &amp;kernel_ft, &amp;user_ft);</div>
<div class="line"></div>
<div class="line">    ULARGE_INTEGER kernel_start, kernel_elapsed, user_start, user_elapsed;</div>
<div class="line"></div>
<div class="line">    kernel_start.HighPart = kernel_ft.dwHighDateTime;</div>
<div class="line">    kernel_start.LowPart = kernel_ft.dwLowDateTime;</div>
<div class="line"></div>
<div class="line">    user_start.HighPart = user_ft.dwHighDateTime;</div>
<div class="line">    user_start.LowPart = user_ft.dwLowDateTime;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">short</span> i = 0; <span class="keywordflow">while</span>(++i);</div>
<div class="line"></div>
<div class="line">        GetThreadTimes(GetCurrentThread(), &amp;a, &amp;b, &amp;kernel_ft, &amp;user_ft);</div>
<div class="line"></div>
<div class="line">        kernel_elapsed.HighPart = kernel_ft.dwHighDateTime;</div>
<div class="line">        kernel_elapsed.LowPart = kernel_ft.dwLowDateTime;</div>
<div class="line"></div>
<div class="line">        user_elapsed.HighPart = user_ft.dwHighDateTime;</div>
<div class="line">        user_elapsed.LowPart = user_ft.dwLowDateTime;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span>(((kernel_elapsed.QuadPart + user_elapsed.QuadPart) - (kernel_start.QuadPart + user_start.QuadPart)) &lt; 10000000);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#elif defined(__linux__)</span></div>
<div class="line"><span class="preprocessor"></span>    rusage r;</div>
<div class="line">    getrusage(RUSAGE_THREAD, &amp;r);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> start, elapsed;</div>
<div class="line">    start = r.ru_utime.tv_sec + r.ru_stime.tv_sec + ((r.ru_utime.tv_usec + r.ru_stime.tv_usec) / 1000000.);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> c = 0; <span class="keywordflow">while</span>(++c);</div>
<div class="line"></div>
<div class="line">        getrusage(RUSAGE_THREAD, &amp;r);</div>
<div class="line"></div>
<div class="line">        elapsed = r.ru_utime.tv_sec + r.ru_stime.tv_sec + ((r.ru_utime.tv_usec + r.ru_stime.tv_usec) / 1000000.);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span>(elapsed - start &lt; 1.);</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">#elif defined(__APPLE__)</span></div>
<div class="line"><span class="preprocessor"></span>    task_thread_times_info info;</div>
<div class="line">    mach_msg_type_number_t number = TASK_THREAD_TIMES_INFO_COUNT;</div>
<div class="line">    task_info(mach_task_self(), TASK_THREAD_TIMES_INFO, (task_info_t)&amp;info, &amp;number);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">double</span> start, elapsed;</div>
<div class="line">    start = info.user_time.seconds + info.system_time.seconds + ((info.user_time.microseconds + info.system_time.microseconds) * 1e-6);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> c = 0; <span class="keywordflow">while</span>(++c);</div>
<div class="line">        </div>
<div class="line">        task_info(mach_task_self(), TASK_THREAD_TIMES_INFO, (task_info_t)&amp;info, &amp;number);</div>
<div class="line">        </div>
<div class="line">        elapsed = info.user_time.seconds + info.system_time.seconds + ((info.user_time.microseconds + info.system_time.microseconds) * 1e-6);</div>
<div class="line">    }<span class="keywordflow">while</span>(elapsed - start &lt; 1.);</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create an int tree that will not cache values.</span></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;int, expression_tree::no_caching&gt;</a> tinc;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Let&#39;s build the simplest of trees, a singe leaf:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//        3</span></div>
<div class="line"></div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = 3;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tinc.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;3&quot;.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Let&#39;s build a more complex tree:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//  (2 * l + r)</span></div>
<div class="line">    <span class="comment">//   /       \</span></div>
<div class="line"><span class="comment">    //  1      (l - r)</span></div>
<div class="line">    <span class="comment">//          /   \</span></div>
<div class="line"><span class="comment">    //        2      3</span></div>
<div class="line"></div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = [](<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j){ <span class="keywordflow">return</span> 2 * i + j; };</div>
<div class="line"></div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().left() = 1;</div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right() = minus&lt;int&gt;();</div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().left() = 2;</div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right() = 3;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tinc.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;1&quot; (2 * 1 + (2 - 3)).</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Re-evaluate the tree.</span></div>
<div class="line">    <span class="comment">// Because it is a non-caching tree, all nodes will be re-visited and all operations re-applied.</span></div>
<div class="line">    cout &lt;&lt; tinc.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Let&#39;s change the tree a bit. Make one leaf a variable:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//  (2 * l + r)</span></div>
<div class="line">    <span class="comment">//   /       \</span></div>
<div class="line"><span class="comment">    //  1      (l - r)</span></div>
<div class="line">    <span class="comment">//          /   \</span></div>
<div class="line"><span class="comment">    //        2      x</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Assign a variable to the rightmost leaf.</span></div>
<div class="line">    <span class="keywordtype">int</span> x = 1;</div>
<div class="line">    tinc.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right() = &amp;x;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tinc.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;3&quot; (2 * 1 + (2 - 1)).</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Change the value of that variable and re-evaluate.</span></div>
<div class="line">    x = 2;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tinc.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;2&quot; (2 * 1 + (2 - 2)).</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a string tree with caching-on-evaluation optimization.</span></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;string, expression_tree::cache_on_evaluation&gt;</a> tsce;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Let&#39;s build this tree:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//    (l + r)</span></div>
<div class="line">    <span class="comment">//  /         \</span></div>
<div class="line"><span class="comment">    // s        (l + r)</span></div>
<div class="line">    <span class="comment">//           /   \</span></div>
<div class="line"><span class="comment">    //         &quot; &quot;  &quot;tree&quot;</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">string</span> s = <span class="stringliteral">&quot;expression&quot;</span>;</div>
<div class="line"></div>
<div class="line">    tsce.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = plus&lt;string&gt;();</div>
<div class="line">    tsce.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().left() = &amp;s;</div>
<div class="line">    tsce.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right() = plus&lt;string&gt;();</div>
<div class="line">    tsce.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().left() = string(<span class="stringliteral">&quot; &quot;</span>);</div>
<div class="line">    tsce.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right() = string(<span class="stringliteral">&quot;tree&quot;</span>);</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tsce.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;expression tree&quot;.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Change the value of variable s and re-evaluate.</span></div>
<div class="line">    <span class="comment">// Because this is a caching tree, constant branches will not be re-evaluated.</span></div>
<div class="line">    <span class="comment">// For this tree, it means the concatenation of &quot; &quot; and &quot;tree&quot; will not be performed again.</span></div>
<div class="line">    s = <span class="stringliteral">&quot;apple&quot;</span>;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tsce.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;apple tree&quot;.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// But hwat happens if we do change the value of one the leaves that had a constant value?</span></div>
<div class="line">    <span class="comment">// The tree will do the right thing, and discard the previously cached value.</span></div>
<div class="line"></div>
<div class="line">    tsce.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right() = string(<span class="stringliteral">&quot;pie&quot;</span>);</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tsce.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;apple pie&quot;.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Demonstration of a caching-on-modification tree with its degenerate case.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Let&#39;s build this tree:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// (l + r)</span></div>
<div class="line">    <span class="comment">//  /   \</span></div>
<div class="line"><span class="comment">    // 1   (l + r)</span></div>
<div class="line">    <span class="comment">//      /   \</span></div>
<div class="line"><span class="comment">    //     2   (l + r)</span></div>
<div class="line">    <span class="comment">//          /   \</span></div>
<div class="line"><span class="comment">    //         3     4</span></div>
<div class="line"></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;int, expression_tree::cache_on_assignment&gt;</a> tica;</div>
<div class="line"></div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = plus&lt;int&gt;();</div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().left() = 1;</div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right() = plus&lt;int&gt;();</div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().left() = 2;</div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right() = plus&lt;int&gt;();</div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right().left() = 3;</div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right().right() = 4; <span class="comment">// Right here, the entire tree will be pre-evaluated.</span></div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tica.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;10&quot;. Even the first time this tree is evaluated, its value is already cached!</span></div>
<div class="line"></div>
<div class="line">    tica.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>().right().right().right() = 5; <span class="comment">// Again, the entire tree will be pre-evaluated.</span></div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tica.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;11&quot;.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Here&#39;s an example of copying a tree (or sub-tree) to another tree&#39;s node.</span></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;int, expression_tree::cache_on_evaluation&gt;</a> tice;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// We first build a simple tree:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//  (l + r)</span></div>
<div class="line">    <span class="comment">//  /    \</span></div>
<div class="line"><span class="comment">    // y      2</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> y = 2;</div>
<div class="line"></div>
<div class="line">    tice.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = plus&lt;int&gt;();</div>
<div class="line">    tice.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>() = &amp;y;</div>
<div class="line">    tice.<a class="code" href="classexpression__tree_1_1node.html#a09f487cc633fcf14cac5565b1ac9b1f1" title="This node&#39;s right child.">right</a>() = 2;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tice.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;4&quot; (y + 2).</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Then we build on it (using its own nodes!):</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//     (l + r)</span></div>
<div class="line">    <span class="comment">//      /   \</span></div>
<div class="line"><span class="comment">    // (l + r)   2</span></div>
<div class="line">    <span class="comment">//  /   \</span></div>
<div class="line"><span class="comment">    // y     2</span></div>
<div class="line"></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1node.html" title="The tree&#39;s node class.">expression_tree::node&lt;int, expression_tree::cache_on_evaluation&gt;</a> n = tice.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>();</div>
<div class="line"></div>
<div class="line">    tice.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>() = n;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Let&#39;s make it even bigger:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//     (l + r)</span></div>
<div class="line">    <span class="comment">//      /   \</span></div>
<div class="line"><span class="comment">    // (l + r)  (l + r)</span></div>
<div class="line">    <span class="comment">//  /   \    /   \</span></div>
<div class="line"><span class="comment">    // y     2  y     2</span></div>
<div class="line"></div>
<div class="line">    tice.<a class="code" href="classexpression__tree_1_1node.html#a09f487cc633fcf14cac5565b1ac9b1f1" title="This node&#39;s right child.">right</a>() = n;</div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; tice.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>() &lt;&lt; endl; <span class="comment">// Prints &quot;8&quot; ((y + 2) + (y + 2)).</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Demonstration of parallel evaluation.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// We build two trees with the exact same morphology, one to be evaluated sequentially and another, parallely.</span></div>
<div class="line">    <span class="comment">// Nodes operation is to stay busy for one second.</span></div>
<div class="line">    <span class="comment">// Leaves have no value of consequence.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//              busy 1s              // Level 1</span></div>
<div class="line">    <span class="comment">//             /       \</span></div>
<div class="line"><span class="comment">    //      busy 1s         busy 1s      // Level 2</span></div>
<div class="line">    <span class="comment">//      /     \         /     \  </span></div>
<div class="line">    <span class="comment">// busy 1s busy 1s busy 1s busy 1s   // Level 3</span></div>
<div class="line">    <span class="comment">//  /   \   /   \   /   \   /   \ </span></div>
<div class="line">    <span class="comment">// 0     0 0     0 0     0 0     0   // Level 4     (instantaneous evaluation)</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// It should take 7 seconds to evaluate the sequential tree, but less time to evaluate the parallel one.</span></div>
<div class="line">    <span class="comment">// If one&#39;s hardware can execute two threads in parallel, level 3 can be evaluated in two seconds and level 2 in one second.</span></div>
<div class="line">    <span class="comment">// If one&#39;s hardware can execute four threads in parallel, level 3 and level 2 can each be evaluated in one second.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// The sequential tree.</span></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;nullptr_t, expression_tree::no_caching, expression_tree::sequential&gt;</a> tnncl;</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = &amp;busy_1_sec;</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>() = &amp;busy_1_sec;</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left() = &amp;busy_1_sec;</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left().left() = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left().right() = tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left().left();</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().right() = tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left();</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a09f487cc633fcf14cac5565b1ac9b1f1" title="This node&#39;s right child.">right</a>() = tnncl.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">auto</span> then = chrono::high_resolution_clock::now();</div>
<div class="line">    tnncl.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>();</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Sequential tree evaluated in &quot;</span> &lt;&lt; chrono::duration&lt;float&gt;(chrono::high_resolution_clock::now() - then).count() &lt;&lt; <span class="stringliteral">&quot; seconds.\n&quot;</span>;    <span class="comment">// 7 seconds.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// The parallel tree.</span></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;nullptr_t, expression_tree::no_caching, expression_tree::parallel&gt;</a> tnncp;</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = &amp;busy_1_sec;</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>() = &amp;busy_1_sec;</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left() = &amp;busy_1_sec;</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left().left() = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left().right() = tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left().left();</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().right() = tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>().left();</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a09f487cc633fcf14cac5565b1ac9b1f1" title="This node&#39;s right child.">right</a>() = tnncp.<a class="code" href="classexpression__tree_1_1node.html#a60b2f43352f6f415d179348660349ba5" title="This node&#39;s left child.">left</a>();</div>
<div class="line"></div>
<div class="line">    then = chrono::high_resolution_clock::now();</div>
<div class="line">    tnncp.<a class="code" href="classexpression__tree_1_1node.html#a5e59093578b9bde98fa75439643e8aad" title="Evaluates the value of this node.">evaluate</a>();</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Parallel tree evaluated in &quot;</span> &lt;&lt; chrono::duration&lt;float&gt;(chrono::high_resolution_clock::now() - then).count() &lt;&lt; <span class="stringliteral">&quot; seconds.\n&quot;</span>;  <span class="comment">// 3 seconds on my computer.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Misues.</span></div>
<div class="line"></div>
<div class="line">    <a class="code" href="classexpression__tree_1_1tree.html" title="Implements an expression tree.">expression_tree::tree&lt;float&gt;</a> crash;</div>
<div class="line">    <span class="comment">//crash.evaluate(); // The tree is empty.</span></div>
<div class="line"></div>
<div class="line">    crash.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = divides&lt;float&gt;();</div>
<div class="line">    <span class="comment">//crash.evaluate(); // This tree cannot be evaluated, its root node is an operation with no data children to operate on.</span></div>
<div class="line"></div>
<div class="line">    crash.<a class="code" href="classexpression__tree_1_1tree.html#a713b455b50ba68bddd51715e50f14688" title="This tree&#39;s root node.">root</a>() = 2.;</div>
<div class="line">    <span class="comment">//crash.root().left() = divides&lt;float&gt;(); // Assigning to a leaf node&#39;s children is undefined behavior.</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="license"></a>
License</h1>
<pre class="fragment">Boost Software License - Version 1.0 - August 17th, 2003

Permission is hereby granted, free of charge, to any person or organization
obtaining a copy of the software and accompanying documentation covered by
this license (the "Software") to use, reproduce, display, distribute,
execute, and transmit the Software, and to prepare derivative works of the
Software, and to permit third-parties to whom the Software is furnished to
do so, all subject to the following:

The copyright notices in the Software and this entire statement, including
the above license grant, this restriction and the following disclaimer,
must be included in all copies of the Software, in whole or in part, and
all derivative works of the Software, unless such copies or derivative
works are solely in the form of machine-executable object code generated by
a source language processor.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 12 2013 15:44:37 for expression_tree by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
